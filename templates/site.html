<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Calculadora DIFAL</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">
<div class="container mt-5">

    <div class="card shadow p-4">
        <h2 class="text-center mb-3">📊 <b>Calculadora DIFAL</b></h2>

        <!-- Mensagens flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <!-- Upload da base -->
        <form action="{{ url_for('upload_base') }}" method="POST" enctype="multipart/form-data" class="mb-3">
            <div class="input-group">
                <input type="file" class="form-control" name="file" required>
                <button type="submit" class="btn btn-primary">Carregar Base</button>
            </div>
        </form>

        {% if produtos %}
        <!-- Remover base -->
        <form action="{{ url_for('remove_base') }}" method="POST" class="mb-4">
            <button type="submit" class="btn btn-danger"
                onclick="return confirm('Tem certeza que deseja remover a base atual?');">
                Remover Base de Produtos
            </button>
        </form>

        <!-- Upload de PDF/Imagem para preencher produtos -->
        <form action="{{ url_for('upload_pdf') }}" method="POST" enctype="multipart/form-data" class="mb-4">
            <label class="form-label">📄 Enviar PDF/Imagem da Cotação:</label>
            <div class="input-group">
                <input type="file" class="form-control" name="pdf_file" accept=".pdf,.jpg,.jpeg,.png" required>
                <button type="submit" class="btn btn-secondary">Preencher Produtos</button>
            </div>
        </form>

        <!-- Formulário de cálculo DIFAL -->
        <form action="{{ url_for('compute') }}" method="POST">
            <div class="mb-3">
                <label class="form-label">UF de Destino:</label>
                <select name="destino_uf" class="form-select" required>
                    {% for uf in ufs %}
                        <option value="{{ uf }}">{{ uf }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Seção de Custos Adicionais -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">💰 Custos Adicionais</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Frete (R$)</label>
                            <input type="number" step="0.01" name="valor_frete" class="form-control" 
                                   placeholder="0,00" value="{{ valor_frete_encontrado if valor_frete_encontrado else '0.00' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Seguro (R$)</label>
                            <input type="number" step="0.01" name="valor_seguro" class="form-control" 
                                   placeholder="0,00" value="0.00">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Outros (R$)</label>
                            <input type="number" step="0.01" name="valor_outros" class="form-control" 
                                   placeholder="0,00" value="0.00">
                        </div>
                    </div>
                    <small class="text-muted mt-2 d-block">
                        💡 Estes valores serão incluídos na base de cálculo do DIFAL e distribuídos proporcionalmente entre os produtos.
                    </small>
                </div>
            </div>

            <!-- Checkbox Uso e Consumo -->
            <div class="form-check mb-3">
                <input type="checkbox" name="uso-consumo" class="form-check-input" id="uso-consumo" 
                       onchange="toggleValorFields(this.checked)">
                <label for="uso-consumo" class="form-check-label">Considerar uso e consumo (calcular com Preço c/ IPI)</label>
            </div>

            <!-- Seção de Produtos -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">📦 Produtos</h6>
                </div>
                <div class="card-body">
                    <div id="produtos-container">
                        {% if produtos_extraidos %}
                            {% for p in produtos_extraidos %}
                            <div class="row mb-2 produto-row">
                                <div class="col-md-2">
                                    <label class="form-label small">Código</label>
                                    <input type="text" name="codigo[]" class="form-control" value="{{ p.codigo }}" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Preço s/ IPI</label>
                                    <input type="number" step="0.01" name="valor_unit[]" class="form-control valor-field" 
                                           value="{{ p.valor_unit }}" data-valor-unit="{{ p.valor_unit }}" 
                                           data-valor-unit-c-ipi="{{ p.valor_unit_c_ipi }}" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Preço c/ IPI</label>
                                    <input type="number" step="0.01" name="preco_unit_c_ipi[]" class="form-control valor-c-ipi-field" 
                                           value="{{ p.valor_unit_c_ipi }}" required>
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label small">Quantidade</label>
                                    <input type="number" step="1" name="qtd[]" class="form-control" value="{{ p.qtd }}" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">%ICMS Doc</label>
                                    <div class="input-group">
                                        <input type="hidden" name="icms_pct[]" value="{{ p.icms_pct }}">
                                        <input type="text" class="form-control bg-light" value="{{ p.icms_pct }}%" readonly>
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                                <div class="col-md-1 d-flex align-items-end">
                                    <button type="button" class="btn btn-success btn-add">+</button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div class="row mb-2 produto-row">
                            <div class="col-md-2">
                                <label class="form-label small">Código</label>
                                <input type="text" name="codigo[]" class="form-control" placeholder="Código" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">Preço s/ IPI</label>
                                <input type="number" step="0.01" name="valor_unit[]" class="form-control valor-field" 
                                       placeholder="0,00" data-valor-unit="" data-valor-unit-c-ipi="" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">Preço c/ IPI</label>
                                <input type="number" step="0.01" name="preco_unit_c_ipi[]" class="form-control valor-c-ipi-field" 
                                       placeholder="0,00" required>
                            </div>
                            <div class="col-md-1">
                                <label class="form-label small">Quantidade</label>
                                <input type="number" step="1" name="qtd[]" class="form-control" placeholder="Qtd" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">%ICMS Doc</label>
                                <div class="input-group">
                                    <input type="hidden" name="icms_pct[]" value="0.0">
                                    <input type="text" class="form-control bg-light" value="0.0%" readonly>
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <div class="col-md-1 d-flex align-items-end">
                                <button type="button" class="btn btn-success btn-add">+</button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="alert alert-info mt-3">
                <small>
                    <strong>💡 Informação:</strong> 
                    <span id="modo-info">Quando "Uso e consumo" estiver marcado, o cálculo será feito usando o Preço c/ IPI.</span>
                    <br>
                    <strong>💰 Custos Adicionais:</strong> Frete, seguro e outros valores serão incluídos na base de cálculo do DIFAL.
                    <br>
                    <strong>📋 Nova Funcionalidade:</strong> O %ICMS é extraído automaticamente do PDF e usado no cálculo do DIFAL.
                </small>
            </div>

            <button type="submit" class="btn btn-success mt-3">Calcular DIFAL</button>
        </form>

        {% else %}
        <div class="alert alert-warning text-center">
            ⚠ Nenhum produto carregado na base! Faça upload de uma planilha para começar.
        </div>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Função para alternar entre os campos de valor baseado no checkbox
function toggleValorFields(usoConsumo) {
    const valorFields = document.querySelectorAll('.valor-field');
    const valorCIPIFields = document.querySelectorAll('.valor-c-ipi-field');
    const modoInfo = document.getElementById('modo-info');
    
    if (usoConsumo) {
        modoInfo.innerHTML = 'Modo Uso e Consumo: O cálculo será feito usando o Preço c/ IPI.<br><strong>💰 Custos Adicionais:</strong> Frete, seguro e outros valores serão incluídos na base de cálculo do DIFAL.<br><strong>📋 Nova Funcionalidade:</strong> O %ICMS é extraído automaticamente do PDF e usado no cálculo do DIFAL.';
        // Destacar campo c/ IPI
        valorCIPIFields.forEach(field => {
            field.style.border = '2px solid #28a745';
            field.style.backgroundColor = '#f8fff9';
        });
        valorFields.forEach(field => {
            field.style.border = '1px solid #ced4da';
            field.style.backgroundColor = '';
        });
    } else {
        modoInfo.innerHTML = 'Modo Normal: O cálculo será feito usando o Preço s/ IPI.<br><strong>💰 Custos Adicionais:</strong> Frete, seguro e outros valores serão incluídos na base de cálculo do DIFAL.<br><strong>📋 Nova Funcionalidade:</strong> O %ICMS é extraído automaticamente do PDF e usado no cálculo do DIFAL.';
        // Destacar campo s/ IPI
        valorFields.forEach(field => {
            field.style.border = '2px solid #007bff';
            field.style.backgroundColor = '#f0f8ff';
        });
        valorCIPIFields.forEach(field => {
            field.style.border = '1px solid #ced4da';
            field.style.backgroundColor = '';
        });
    }
}

// Sincronizar valores quando usuário digitar
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('valor-field')) {
        const row = e.target.closest('.produto-row');
        const valorField = row.querySelector('.valor-field');
        const valorCIPIField = row.querySelector('.valor-c-ipi-field');
        
        // Atualizar data attributes
        valorField.setAttribute('data-valor-unit', valorField.value);
        if (!valorCIPIField.value) {
            valorCIPIField.value = valorField.value;
        }
    }
    
    if (e.target.classList.contains('valor-c-ipi-field')) {
        const row = e.target.closest('.produto-row');
        const valorField = row.querySelector('.valor-field');
        const valorCIPIField = row.querySelector('.valor-c-ipi-field');
        
        // Atualizar data attribute
        valorField.setAttribute('data-valor-unit-c-ipi', valorCIPIField.value);
    }
});

// Gerenciar adição/remoção de linhas
document.addEventListener("click", function(e) {
    if (e.target.classList.contains("btn-add")) {
        e.preventDefault();
        const container = document.getElementById("produtos-container");
        const row = e.target.closest(".produto-row");
        const clone = row.cloneNode(true);

        // Limpar valores mas manter estrutura
        clone.querySelectorAll("input[type='text'], input[type='number']").forEach(input => {
            if (!input.classList.contains('bg-light')) { // Não limpar campos readonly
                input.value = "";
            }
            if (input.classList.contains('valor-field')) {
                input.setAttribute('data-valor-unit', '');
                input.setAttribute('data-valor-unit-c-ipi', '');
            }
        });
        
        // Resetar campo %ICMS para 0% em novas linhas
        const icmsHiddenInput = clone.querySelector('input[name="icms_pct[]"]');
        const icmsDisplayInput = clone.querySelector('input[type="text"].bg-light');
        if (icmsHiddenInput && icmsDisplayInput) {
            icmsHiddenInput.value = "0.0";
            icmsDisplayInput.value = "0.0%";
        }
        
        const btn = clone.querySelector(".btn-add");
        btn.textContent = "−";
        btn.classList.remove("btn-success", "btn-add");
        btn.classList.add("btn-danger", "btn-remove");

        container.appendChild(clone);
        
        // Aplicar estilo baseado no checkbox atual
        const usoConsumoCheckbox = document.getElementById('uso-consumo');
        toggleValorFields(usoConsumoCheckbox.checked);
    }

    if (e.target.classList.contains("btn-remove")) {
        e.preventDefault();
        if (document.querySelectorAll('.produto-row').length > 1) {
            e.target.closest(".produto-row").remove();
        } else {
            alert('É necessário ter pelo menos um produto!');
        }
    }
});

// Inicializar estado dos campos
document.addEventListener('DOMContentLoaded', function() {
    const usoConsumoCheckbox = document.getElementById('uso-consumo');
    toggleValorFields(usoConsumoCheckbox.checked);
});

// Validação do formulário
document.querySelector('form').addEventListener('submit', function(e) {
    const codigos = document.querySelectorAll('input[name="codigo[]"]');
    const valores = document.querySelectorAll('input[name="valor_unit[]"]');
    const quantidades = document.querySelectorAll('input[name="qtd[]"]');
    
    for (let i = 0; i < codigos.length; i++) {
        if (!codigos[i].value.trim()) {
            e.preventDefault();
            alert('Por favor, preencha todos os códigos dos produtos.');
            codigos[i].focus();
            return;
        }
        
        if (parseFloat(valores[i].value) <= 0) {
            e.preventDefault();
            alert('O valor unitário deve ser maior que zero.');
            valores[i].focus();
            return;
        }
        
        if (parseInt(quantidades[i].value) <= 0) {
            e.preventDefault();
            alert('A quantidade deve ser maior que zero.');
            quantidades[i].focus();
            return;
        }
    }
});
</script>

<style>
.valor-field, .valor-c-ipi-field {
    transition: all 0.3s ease;
}
.produto-row {
    align-items: end;
}
.form-label.small {
    font-size: 0.8rem;
    font-weight: 600;
    margin-bottom: 0.2rem;
}
.btn-add, .btn-remove {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}
.input-group-text {
    font-size: 0.8rem;
}
.card-header h6 {
    font-size: 1rem;
}
</style>

</body>
</html>